#include <psp2/display.h>
#include <psp2/kernel/sysmem.h>
#include <psp2/kernel/threadmgr.h>
#include <psp2/kernel/memmgr.h> // ADICIONADO para alocação de memória do Kernel
#include <stdarg.h>
#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <malloc.h>

#include "debugScreen.h"

#define SCREEN_WIDTH 960
#define SCREEN_HEIGHT 544
#define SCREEN_PITCH 960
#define PIXEL_FORMAT SCE_DISPLAY_PIXELFORMAT_A8B8G8R8
#define FRAMEBUFFER_SIZE (SCREEN_PITCH * SCREEN_HEIGHT * 4)
#define FRAMEBUFFER_ALIGNMENT (256 * 1024)

unsigned char msx_font[] = {
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x5F,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x00, 0x07, 0x00, 0x00, 0x00,
	0x14, 0x7F, 0x14, 0x7F, 0x14, 0x00, 0x00, 0x00, 0x24, 0x2A, 0x7F, 0x2A,
	0x12, 0x00, 0x00, 0x00, 0x23, 0x13, 0x08, 0x64, 0x62, 0x00, 0x00, 0x00,
	0x36, 0x49, 0x55, 0x22, 0x50, 0x00, 0x00, 0x00, 0x00, 0x05, 0x03, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x1C, 0x22, 0x41, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x41, 0x22, 0x1C, 0x00, 0x00, 0x00, 0x00, 0x08, 0x2A, 0x1C, 0x2A,
	0x08, 0x00, 0x00, 0x00, 0x08, 0x08, 0x3E, 0x08, 0x08, 0x00, 0x00, 0x00,
	0x00, 0x50, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x08, 0x08, 0x08,
	0x08, 0x00, 0x00, 0x00, 0x00, 0x60, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x20, 0x10, 0x08, 0x04, 0x02, 0x00, 0x00, 0x00, 0x3E, 0x51, 0x49, 0x45,
	0x3E, 0x00, 0x00, 0x00, 0x00, 0x42, 0x7F, 0x40, 0x00, 0x00, 0x00, 0x00,
	0x42, 0x61, 0x51, 0x49, 0x46, 0x00, 0x00, 0x00, 0x21, 0x41, 0x45, 0x4B,
	0x31, 0x00, 0x00, 0x00, 0x18, 0x14, 0x12, 0x7F, 0x10, 0x00, 0x00, 0x00,
	0x27, 0x45, 0x45, 0x45, 0x39, 0x00, 0x00, 0x00, 0x3C, 0x4A, 0x49, 0x49,
	0x30, 0x00, 0x00, 0x00, 0x01, 0x71, 0x09, 0x05, 0x03, 0x00, 0x00, 0x00,
	0x36, 0x49, 0x49, 0x49, 0x36, 0x00, 0x00, 0x00, 0x06, 0x49, 0x49, 0x29,
	0x1E, 0x00, 0x00, 0x00, 0x00, 0x36, 0x36, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x56, 0x36, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x14, 0x22, 0x41,
	0x00, 0x00, 0x00, 0x00, 0x14, 0x14, 0x14, 0x14, 0x14, 0x00, 0x00, 0x00,
	0x00, 0x41, 0x22, 0x14, 0x08, 0x00, 0x00, 0x00, 0x02, 0x01, 0x51, 0x09,
	0x06, 0x00, 0x00, 0x00, 0x32, 0x49, 0x79, 0x41, 0x3E, 0x00, 0x00, 0x00,
	0x7E, 0x11, 0x11, 0x11, 0x7E, 0x00, 0x00, 0x00, 0x7F, 0x49, 0x49, 0x49,
	0x36, 0x00, 0x00, 0x00, 0x3E, 0x41, 0x41, 0x41, 0x22, 0x00, 0x00, 0x00,
	0x7F, 0x41, 0x41, 0x22, 0x1C, 0x00, 0x00, 0x00, 0x7F, 0x49, 0x49, 0x49,
	0x41, 0x00, 0x00, 0x00, 0x7F, 0x09, 0x09, 0x09, 0x01, 0x00, 0x00, 0x00,
	0x3E, 0x41, 0x41, 0x51, 0x72, 0x00, 0x00, 0x00, 0x7F, 0x08, 0x08, 0x08,
	0x7F, 0x00, 0x00, 0x00, 0x00, 0x41, 0x7F, 0x41, 0x00, 0x00, 0x00, 0x00,
	0x20, 0x40, 0x41, 0x3F, 0x01, 0x00, 0x00, 0x00, 0x7F, 0x08, 0x14, 0x22,
	0x41, 0x00, 0x00, 0x00, 0x7F, 0x40, 0x40, 0x40, 0x40, 0x00, 0x00, 0x00,
	0x7F, 0x02, 0x0C, 0x02, 0x7F, 0x00, 0x00, 0x00, 0x7F, 0x02, 0x04, 0x02,
	0x7F, 0x00, 0x00, 0x00, 0x3E, 0x41, 0x41, 0x41, 0x3E, 0x00, 0x00, 0x00,
	0x7F, 0x09, 0x09, 0x09, 0x06, 0x00, 0x00, 0x00, 0x3E, 0x41, 0x51, 0x21,
	0x5E, 0x00, 0x00, 0x00, 0x7F, 0x09, 0x19, 0x29, 0x46, 0x00, 0x00, 0x00,
	0x26, 0x49, 0x49, 0x49, 0x32, 0x00, 0x00, 0x00, 0x01, 0x01, 0x7F, 0x01,
	0x01, 0x00, 0x00, 0x00, 0x3F, 0x40, 0x40, 0x40, 0x3F, 0x00, 0x00, 0x00,
	0x1F, 0x20, 0x40, 0x20, 0x1F, 0x00, 0x00, 0x00, 0x3F, 0x40, 0x38, 0x40,
	0x3F, 0x00, 0x00, 0x00, 0x63, 0x14, 0x08, 0x14, 0x63, 0x00, 0x00, 0x00,
	0x07, 0x08, 0x70, 0x08, 0x07, 0x00, 0x00, 0x00, 0x61, 0x51, 0x49, 0x45,
	0x43, 0x00, 0x00, 0x00, 0x00, 0x7F, 0x41, 0x41, 0x00, 0x00, 0x00, 0x00,
	0x02, 0x04, 0x08, 0x10, 0x20, 0x00, 0x00, 0x00, 0x00, 0x41, 0x41, 0x7F,
	0x00, 0x00, 0x00, 0x00, 0x04, 0x02, 0x01, 0x02, 0x04, 0x00, 0x00, 0x00,
	0x40, 0x40, 0x40, 0x40, 0x40, 0x00, 0x00, 0x00, 0x00, 0x01, 0x02, 0x04,
	0x00, 0x00, 0x00, 0x00, 0x20, 0x54, 0x54, 0x54, 0x78, 0x00, 0x00, 0x00,
	0x7F, 0x48, 0x48, 0x48, 0x30, 0x00, 0x00, 0x00, 0x38, 0x44, 0x44, 0x44,
	0x20, 0x00, 0x00, 0x00, 0x38, 0x44, 0x44, 0x48, 0x7F, 0x00, 0x00, 0x00,
	0x38, 0x54, 0x54, 0x54, 0x08, 0x00, 0x00, 0x00, 0x08, 0x7E, 0x09, 0x01,
	0x02, 0x00, 0x00, 0x00, 0x0C, 0x52, 0x52, 0x52, 0x3E, 0x00, 0x00, 0x00,
	0x7F, 0x08, 0x04, 0x04, 0x78, 0x00, 0x00, 0x00, 0x00, 0x44, 0x7D, 0x40,
	0x00, 0x00, 0x00, 0x00, 0x20, 0x40, 0x44, 0x3D, 0x00, 0x00, 0x00, 0x00,
	0x7F, 0x10, 0x28, 0x44, 0x00, 0x00, 0x00, 0x00, 0x00, 0x41, 0x7F, 0x40,
	0x00, 0x00, 0x00, 0x00, 0x7C, 0x04, 0x18, 0x04, 0x78, 0x00, 0x00, 0x00,
	0x7C, 0x08, 0x04, 0x04, 0x78, 0x00, 0x00, 0x00, 0x38, 0x44, 0x44, 0x44,
	0x38, 0x00, 0x00, 0x00, 0x7C, 0x14, 0x14, 0x14, 0x08, 0x00, 0x00, 0x00,
	0x08, 0x14, 0x14, 0x18, 0x7C, 0x00, 0x00, 0x00, 0x7C, 0x08, 0x04, 0x04,
	0x08, 0x00, 0x00, 0x00, 0x48, 0x54, 0x54, 0x54, 0x20, 0x00, 0x00, 0x00,
	0x04, 0x3F, 0x44, 0x40, 0x20, 0x00, 0x00, 0x00, 0x3C, 0x40, 0x40, 0x20,
	0x7C, 0x00, 0x00, 0x00, 0x1C, 0x20, 0x40, 0x20, 0x1C, 0x00, 0x00, 0x00,
	0x3C, 0x40, 0x30, 0x40, 0x3C, 0x00, 0x00, 0x00, 0x44, 0x28, 0x10, 0x28,
	0x44, 0x00, 0x00, 0x00, 0x0C, 0x50, 0x50, 0x50, 0x3C, 0x00, 0x00, 0x00,
	0x44, 0x64, 0x54, 0x4C, 0x44, 0x00, 0x00, 0x00, 0x00, 0x08, 0x36, 0x41,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7F, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x41, 0x36, 0x08, 0x00, 0x00, 0x00, 0x00, 0x02, 0x01, 0x02, 0x01,
	0x00, 0x00, 0x00, 0x00,
};

// Variáveis globais
static int g_x = 0, g_y = 0;
static unsigned int g_fg_color = 0xFFFFFFFF;
static unsigned int g_bg_color = 0x00000000;
static void *g_vram_base = NULL;
static SceUID g_memblock_uid; // UID para nosso bloco de memória

static void psvDebugScreenPutPixel(int x, int y, unsigned int color) {
    if (x < 0 || x >= SCREEN_WIDTH || y < 0 || y >= SCREEN_HEIGHT) return;
    if (g_vram_base) {
        ((unsigned int *)g_vram_base)[x + y * SCREEN_PITCH] = color;
    }
}

static void psvDebugScreenClear() {
    int x, y;
    for (y = 0; y < SCREEN_HEIGHT; y++) {
        for (x = 0; x < SCREEN_WIDTH; x++) {
            psvDebugScreenPutPixel(x, y, g_bg_color);
        }
    }
    g_x = 0; g_y = 0;
}

static void psvDebugScreenPutChar(int x, int y, unsigned int color, unsigned char ch) {
    if (ch < 32 || ch >= 127) ch = '?';
    unsigned char *font = &msx_font[(ch - 32) * 8];
    int i, j;
    for (i = 0; i < 8; i++) {
        for (j = 0; j < 8; j++) {
            if ((*font & (128 >> j))) {
                psvDebugScreenPutPixel(x + j, y + i, color);
            } else {
                psvDebugScreenPutPixel(x + j, y + i, g_bg_color);
            }
        }
        font++;
    }
}

// CORRIGIDO: Usando alocação de memória do Kernel
int psvDebugScreenInit() {
    // 1. Alocar um bloco de memória do tipo CDRAM
    g_memblock_uid = sceKernelAllocMemBlock("vitatpb_fb", SCE_KERNEL_MEMBLOCK_TYPE_USER_CDRAM_RW, FRAMEBUFFER_SIZE, NULL);
    if (g_memblock_uid < 0) {
        return g_memblock_uid; // Retorna o erro
    }

    // 2. Obter o endereço base do bloco de memória
    if (sceKernelGetMemBlockBase(g_memblock_uid, &g_vram_base) < 0) {
        sceKernelFreeMemBlock(g_memblock_uid);
        return -1;
    }

    // 3. Configurar a estrutura do framebuffer com nosso endereço
    SceDisplayFrameBuf framebuf;
    memset(&framebuf, 0, sizeof(SceDisplayFrameBuf));
    framebuf.size        = sizeof(SceDisplayFrameBuf);
    framebuf.base        = g_vram_base;
    framebuf.pitch       = SCREEN_PITCH;
    framebuf.width       = SCREEN_WIDTH;
    framebuf.height      = SCREEN_HEIGHT;
    framebuf.pixelformat = PIXEL_FORMAT;

    // 4. Definir o framebuffer no sistema
    int ret = sceDisplaySetFrameBuf(&framebuf, SCE_DISPLAY_SETBUF_NEXTFRAME);
    if (ret < 0) {
        sceKernelFreeMemBlock(g_memblock_uid);
        g_vram_base = NULL;
        return ret;
    }
    
    psvDebugScreenClear();
    return 0; // Sucesso
}


void psvDebugScreenPrintf(const char *fmt, ...) {
    char buf[4096];
    va_list args;
    va_start(args, fmt);
    vsnprintf(buf, sizeof(buf), fmt, args);
    va_end(args);

    int i = 0;
    while (buf[i]) {
        char c = buf[i++];
        if (c == '\n') { g_x = 0; g_y += 8; } 
        else if (c == '\r') { g_x = 0; } 
        else {
            if (g_x >= SCREEN_WIDTH) { g_x = 0; g_y += 8; }
            if (g_y >= SCREEN_HEIGHT) { psvDebugScreenClear(); }
            psvDebugScreenPutChar(g_x, g_y, g_fg_color, c);
            g_x += 8;
        }
    }
}
